<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>

	</head>
	<body>
		<script src="three.js"></script>
		<script>
            var scene, camera, renderer, mesh, clock;
            var meshFloor, ambientLight, light;

            var keyboard = {};
            var player = { height:1.8, speed:0.2, canShoot:0, ship:0 };
            var USE_WIREFRAME = false;

            // var loadingScreen = {
            //     scene: new THREE.Scene(),
            //     camera: new THREE.PerspectiveCamera(90, 1280/720, 0.1, 100),
            //     box: new THREE.Mesh(
            //         new THREE.BoxGeometry(0.5,0.5,0.5),
            //         new THREE.MeshBasicMaterial({ color:0x4444ff })
            //     )
            // };
            // var loadingManager = null;


            // Meshes index
            var meshes = {};

            // Bullets array
            var bullets = [];

            // Ships array
            var ships1 = [];
            var ships2 = [];
            var ships3 = [];

            function init(){
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(90, 1280/720, 0.1, 1000);
                clock = new THREE.Clock();


                
                // loadingScreen.box.position.set(0,0,5);
                // loadingScreen.camera.lookAt(loadingScreen.box.position);
                // loadingScreen.scene.add(loadingScreen.box);
                
                // loadingManager = new THREE.LoadingManager();
                // loadingManager.onProgress = function(item, loaded, total){
                //     console.log(item, loaded, total);
                // };
                // loadingManager.onLoad = function(){
                //     console.log("loaded all resources");
                //     RESOURCES_LOADED = true;
                //     onResourcesLoaded();
                // };
                

                
                meshFloor = new THREE.Mesh(
                    new THREE.PlaneGeometry(30,30, 10,10),
                    new THREE.MeshPhongMaterial({color:0xffffff, wireframe:USE_WIREFRAME})
                );
                meshFloor.rotation.x -= Math.PI / 2;
                meshFloor.receiveShadow = true;
                scene.add(meshFloor);
                
                
                ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
                scene.add(ambientLight);
                
                light = new THREE.PointLight(0xffffff, 0.8, 18);
                light.position.set(-3,6,-3);
                light.castShadow = true;
                light.shadow.camera.near = 0.1;
                light.shadow.camera.far = 25;
                scene.add(light);
                

                
                camera.position.set(0, player.height, -5);
                camera.lookAt(new THREE.Vector3(0,player.height,0));
                
                renderer = new THREE.WebGLRenderer();
                renderer.setSize(1280, 720);

                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.BasicShadowMap;
                
                document.body.appendChild(renderer.domElement);
                animate();
            }

            function animate(){

                // // Play the loading screen until resources are loaded.
                // if( RESOURCES_LOADED == false ){
                //     requestAnimationFrame(animate);
                    
                //     loadingScreen.box.position.x -= 0.05;
                //     if( loadingScreen.box.position.x < -10 ) loadingScreen.box.position.x = 10;
                //     loadingScreen.box.position.y = Math.sin(loadingScreen.box.position.x);
                    
                //     renderer.render(loadingScreen.scene, loadingScreen.camera);
                //     return;
                // }

                
                
                var time = Date.now() * 0.0005;
                var delta = clock.getDelta();
                

                for(var index=0; index<ships1.length; index+=1){
                    if( ships1[index] === undefined ) continue;
                    if( ships1[index].alive == false ){
                        scene.remove(ships1[index]);
                        ships1.splice(index,1);
                        continue;
                    }
                    
                    ships1[index].position.add(ships1[index].velocity);
                }  
                for(var index=0; index<ships2.length; index+=1){
                    if( ships2[index] === undefined ) continue;
                    if( ships2[index].alive == false ){
                        ships2.splice(index,1);
                        continue;
                    }
                    
                    ships2[index].position.add(ships2[index].velocity);
                }  
                for(var index=0; index<ships3.length; index+=1){
                    if( ships3[index] === undefined ) continue;
                    if( ships3[index].alive == false ){
                        ships3.splice(index,1);
                        continue;
                    }
                    
                    ships3[index].position.add(ships3[index].velocity);
                }                 
                // go through bullets array and update position
                // remove bullets when appropriate
                for(var index=0; index<bullets.length; index+=1){
                    if( bullets[index] === undefined ) continue;
                    if( bullets[index].alive == false ){
                        bullets.splice(index,1);
                        continue;
                    }
                    
                    bullets[index].position.add(bullets[index].velocity);
                }
             
                if(keyboard[87]){ // W key
                    camera.position.x -= Math.sin(camera.rotation.y) * player.speed;
                    camera.position.z -= -Math.cos(camera.rotation.y) * player.speed;
                }
                if(keyboard[83]){ // S key
                    camera.position.x += Math.sin(camera.rotation.y) * player.speed;
                    camera.position.z += -Math.cos(camera.rotation.y) * player.speed;
                }
                if(keyboard[65]){ // A key
                    camera.position.x += Math.sin(camera.rotation.y + Math.PI/2) * player.speed;
                    camera.position.z += -Math.cos(camera.rotation.y + Math.PI/2) * player.speed;
                }
                if(keyboard[68]){ // D key
                    camera.position.x += Math.sin(camera.rotation.y - Math.PI/2) * player.speed;
                    camera.position.z += -Math.cos(camera.rotation.y - Math.PI/2) * player.speed;
                }
                if(player.ship <= 0){
                    var spriteMap = new THREE.TextureLoader().load( "https://vignette3.wikia.nocookie.net/clubpenguin/images/2/26/Pirate_Ship.PNG/revision/latest?cb=20141119012531" );
                    var spriteMaterial = new THREE.SpriteMaterial( { map: spriteMap, color: 0xffffff } );
                    var sprite = new THREE.Sprite( spriteMaterial );
                    sprite.position.y = 2;
                    sprite.position.x = 10;
                    sprite.scale.set(6 ,4,1);
                    sprite.castShadow = true;

                    sprite.velocity = new THREE.Vector3(
                        -0.1,
                        0,
                        Math.sin(0)
                    );

                    sprite.alive = true;
                    setTimeout(function(){
                        sprite.alive = false;
                    }, 5000);
                    ships1.push(sprite);
                    scene.add( sprite );
                    player.ship = 100;


                }               

                
                // shoot a bullet
                if(keyboard[32] && player.canShoot <= 0){ // spacebar key
                    // creates a bullet as a Mesh object
                    var bullet = new THREE.Mesh(
                        new THREE.SphereGeometry(0.5,8,8),
                        new THREE.MeshBasicMaterial({color:0xffffff})
                    );
		
                    // position the bullet to come from the player's weapon
                    bullet.position.set(
                        camera.position.x,
                        (camera.position.y) - 1,
                        camera.position.z
                    );
                    
                    // set the velocity of the bullet
                    bullet.velocity = new THREE.Vector3(
                        -Math.sin(camera.rotation.y),
                        0,
                        Math.cos(camera.rotation.y)
                    );
                    
                    // after 1000ms, set alive to false and remove from scene
                    // setting alive to false flags our update code to remove
                    // the bullet from the bullets array
                    bullet.alive = true;
                    setTimeout(function(){
                        bullet.alive = false;
                        scene.remove(bullet);
                    }, 1000);
                    
                    // add to scene, array, and set the delay to 10 frames
                    bullets.push(bullet);
                    scene.add(bullet);
                    player.canShoot = 10;
                    
                }
                if(player.canShoot > 0) {
                    player.canShoot -= 1;
                }

                if(player.ship > 0) {
                    player.ship -= 1;
                }
                checkCollisionEnemy(ships1);

                renderer.render(scene, camera);
                requestAnimationFrame(animate);

                if (!(bullets[0]===undefined))
                console.log(bullets[0].position.x);
            }

            function checkCollisionEnemy(ships){
                for(var i=0; i<bullets.length; i+=1){
                    for(var j=0; j<ships.length; j+=1)
                    if ((bullets[i].position.x < ((ships[j].position.x) + 3)) && 
                        (bullets[i].position.x > ((ships[j].position.x) - 2)))
                     if ((bullets[i].position.z < ((ships[j].position.z) + 1)) && 
                        (bullets[i].position.z > ((ships[j].position.z) -1))){
                            scene.remove(ships[j]);
                            ships.splice(j,1);
                            scene.remove(bullets[i]);
                            bullets.splice(i,1);
                        }   
                            
                }
            }

            function keyDown(event){
                keyboard[event.keyCode] = true;
            }

            function keyUp(event){
                keyboard[event.keyCode] = false;
            }

            window.addEventListener('keydown', keyDown);
            window.addEventListener('keyup', keyUp);

            window.onload = init;

		</script>
	</body>
</html>