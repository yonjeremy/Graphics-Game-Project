<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
            #info {
                position: absolute;
                top: 10px;
                left: 10px;
                font-size: 40px;
                width: 100%;
                text-align: left;
                z-index: 100;
                display:block;
                color: white;
                font-family: 'Bungee', cursive;
                
            }

            #health1 {
                position: absolute;
                top: 20px;
                left: 200px;
                width: 80px;
                height: 80px;
                text-align: left;
                z-index: 100;
                display:block;
            }

            #health2 {
                position: absolute;
                top: 20px;
                left: 260px;
                width: 80px;
                height: 80px;
                text-align: left;
                z-index: 100;
                display:block;
            }

            #health3 {
                position: absolute;
                top: 20px;
                left: 320px;
                width: 80px;
                height: 80px;
                text-align: left;
                z-index: 100;
                display:block;
            }

            #score{
                position: absolute;
                top: 10px;
                right: 300px;
                font-size: 40px;
                width: 100%;
                text-align: right;
                z-index: 100;
                display:block;
                color: white;
                font-family: 'Bungee', cursive;
            }
            #scoreNum{
                position: absolute;
                top: 0px;
                right: -150px;
                font-size: 40px;
                width: 100%;
                text-align: right;
                z-index: 100;
                display:block;
                color: white;
                font-family: 'Bungee', cursive;
            }
		</style>
        <link href="https://fonts.googleapis.com/css?family=Bungee" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	</head>
	<body style="border:solid">
        <div id="info">Health:</div>
        <img id="health1" src="https://t7.rbxcdn.com/ebb9856ff7dcb9b82a87621540f82244"/>
        <img id="health2" src="https://t7.rbxcdn.com/ebb9856ff7dcb9b82a87621540f82244"/>
        <img id="health3" src="https://t7.rbxcdn.com/ebb9856ff7dcb9b82a87621540f82244"/>
        <div id="score">Score: <div id="scoreNum">0</div></div>
		<script src="three.js"></script>
		<script>
            var scene, camera, renderer, mesh, clock;
            var meshFloor, ambientLight, light;

            var keyboard = {};
            var player = { height:3, speed:0.1, canShoot:0, ship1:0, ship2:0, ship3:0 };
            var USE_WIREFRAME = false;

            // var loadingScreen = {
            //     scene: new THREE.Scene(),
            //     camera: new THREE.PerspectiveCamera(90, 1280/720, 0.1, 100),
            //     box: new THREE.Mesh(
            //         new THREE.BoxGeometry(0.5,0.5,0.5),
            //         new THREE.MeshBasicMaterial({ color:0x4444ff })
            //     )
            // };
            // var loadingManager = null;

            var health = 3;
            var scoreNum = 0;

            // Meshes index
            var meshes = {};

            // Bullets array
            var bullets = [];
            var shipBullets = [];

            // Ships array
            var ships1 = [];
            var ships2 = [];
            var ships3 = [];

            var canon;

            function init(){
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(90, 900/506.25, 0.1, 1000);
                clock = new THREE.Clock();


                
                // loadingScreen.box.position.set(0,0,5);
                // loadingScreen.camera.lookAt(loadingScreen.box.position);
                // loadingScreen.scene.add(loadingScreen.box);
                
                // loadingManager = new THREE.LoadingManager();
                // loadingManager.onProgress = function(item, loaded, total){
                //     console.log(item, loaded, total);
                // };
                // loadingManager.onLoad = function(){
                //     console.log("loaded all resources");
                //     RESOURCES_LOADED = true;
                //     onResourcesLoaded();
                // };
                
                var spriteMap = new THREE.TextureLoader().load( "https://static.tumblr.com/0fe68a7027788bc0b5736d2fc207c925/xnhvrng/dZxod00pl/tumblr_static_tumblr_static__640.jpg" );
                var spriteMaterial = new THREE.SpriteMaterial( { map: spriteMap, color: 0xffffff } );
                var sprite = new THREE.Sprite( spriteMaterial );
                sprite.position.y = 40;
                sprite.position.z = 50;
                sprite.scale.set(300 ,100,1);

                scene.add( sprite );
                 
                
                meshFloor = new THREE.Mesh(
                    new THREE.PlaneGeometry(200,100, 10,10),
                    new THREE.MeshPhongMaterial({color:0x15e4ef, wireframe:USE_WIREFRAME})
                );
                meshFloor.rotation.x -= Math.PI / 2;
                meshFloor.receiveShadow = true;
                scene.add(meshFloor);

                dock = new THREE.Mesh(
                    new THREE.BoxGeometry(2,1,20,10,10,10),
                    new THREE.MeshPhongMaterial({color:0xD2691E, wireframe:USE_WIREFRAME})
                );
                dock.position.z = -20;
                dock.position.x = 9;
                dock.receiveShadow = true;
                scene.add(dock);
        
                dock = new THREE.Mesh(
                    new THREE.BoxGeometry(2,1,20,10,10,10),
                    new THREE.MeshPhongMaterial({color:0xD2691E, wireframe:USE_WIREFRAME})
                );
                dock.position.z = -20;
                dock.position.x = 6.5;
                dock.receiveShadow = true;
                scene.add(dock);

                dock = new THREE.Mesh(
                    new THREE.BoxGeometry(2,1,20,10,10,10),
                    new THREE.MeshPhongMaterial({color:0xD2691E, wireframe:USE_WIREFRAME})
                );
                dock.position.z = -20;
                dock.position.x = 4;
                dock.receiveShadow = true;
                scene.add(dock);

                dock = new THREE.Mesh(
                    new THREE.BoxGeometry(2,1,20,10,10,10),
                    new THREE.MeshPhongMaterial({color:0xD2691E, wireframe:USE_WIREFRAME})
                );
                dock.position.z = -20;
                dock.position.x = 1.5;
                dock.receiveShadow = true;
                scene.add(dock);

                dock = new THREE.Mesh(
                    new THREE.BoxGeometry(2,1,20,10,10,10),
                    new THREE.MeshPhongMaterial({color:0xD2691E, wireframe:USE_WIREFRAME})
                );
                dock.position.z = -20;
                dock.position.x = -1;
                dock.receiveShadow = true;
                scene.add(dock);

                dock = new THREE.Mesh(
                    new THREE.BoxGeometry(2,1,20,10,10,10),
                    new THREE.MeshPhongMaterial({color:0xD2691E, wireframe:USE_WIREFRAME})
                );
                dock.position.z = -20;
                dock.position.x = -3.5;
                dock.receiveShadow = true;
                scene.add(dock);

                dock = new THREE.Mesh(
                    new THREE.BoxGeometry(2,1,20,10,10,10),
                    new THREE.MeshPhongMaterial({color:0xD2691E, wireframe:USE_WIREFRAME})
                );
                dock.position.z = -20;
                dock.position.x = -6;
                dock.receiveShadow = true;
                scene.add(dock);

                dock = new THREE.Mesh(
                    new THREE.BoxGeometry(2,1,20,10,10,10),
                    new THREE.MeshPhongMaterial({color:0xD2691E, wireframe:USE_WIREFRAME})
                );
                dock.position.z = -20;
                dock.position.x = -8.5;
                dock.receiveShadow = true;
                scene.add(dock);

                // var spriteMap = new THREE.TextureLoader().load( "https://t7.rbxcdn.com/ebb9856ff7dcb9b82a87621540f82244" );
                // var spriteMaterial = new THREE.SpriteMaterial( { map: spriteMap, color: 0xffffff } );
                // var sprite = new THREE.Sprite( spriteMaterial );
                // sprite.position.y = 3;
                // sprite.position.x = 10;
                // sprite.position.z = 0;
                // sprite.scale.set(5 ,5,1);
                // scene.add( sprite );

                // var spriteMap = new THREE.TextureLoader().load( "https://static.tumblr.com/0fe68a7027788bc0b5736d2fc207c925/xnhvrng/dZxod00pl/tumblr_static_tumblr_static__640.jpg" );
                // var spriteMaterial = new THREE.SpriteMaterial( { map: spriteMap, color: 0xffffff } );
                // var sprite = new THREE.Sprite( spriteMaterial );
                // sprite.position.y = 40;
                // sprite.position.z = 50;
                // sprite.scale.set(300 ,100,1);
                // scene.add( sprite );

                // var spriteMap = new THREE.TextureLoader().load( "https://static.tumblr.com/0fe68a7027788bc0b5736d2fc207c925/xnhvrng/dZxod00pl/tumblr_static_tumblr_static__640.jpg" );
                // var spriteMaterial = new THREE.SpriteMaterial( { map: spriteMap, color: 0xffffff } );
                // var sprite = new THREE.Sprite( spriteMaterial );
                // sprite.position.y = 40;
                // sprite.position.z = 50;
                // sprite.scale.set(300 ,100,1);
                // scene.add( sprite );


                var spriteMap = new THREE.TextureLoader().load( "https://steamuserimages-a.akamaihd.net/ugc/840336991424667693/BEE15309C1ABF116635159908DBBBA8B8A6C5AF4/" );
                var spriteMaterial = new THREE.SpriteMaterial( { map: spriteMap, color: 0xffffff } );
                canon = new THREE.Sprite( spriteMaterial );
                canon.scale.set(0.5 ,0.5,0.3);
                
                scene.add( canon );

                ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambientLight);
                
                light = new THREE.PointLight(0xffffff, 0.8, 18);
                light.position.set(-3,6,-3);
                light.castShadow = true;
                light.shadow.camera.near = 0.1;
                light.shadow.camera.far = 25;
                scene.add(light);

                                


                

                
                camera.position.set(0, player.height, -15);
                camera.lookAt(new THREE.Vector3(0,player.height,0));
                
                renderer = new THREE.WebGLRenderer();
                renderer.setSize(900, 506.25);

                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.BasicShadowMap;
                
                document.body.appendChild(renderer.domElement);
                animate();
            }

            function animate(){

                // // Play the loading screen until resources are loaded.
                // if( RESOURCES_LOADED == false ){
                //     requestAnimationFrame(animate);
                    
                //     loadingScreen.box.position.x -= 0.05;
                //     if( loadingScreen.box.position.x < -10 ) loadingScreen.box.position.x = 10;
                //     loadingScreen.box.position.y = Math.sin(loadingScreen.box.position.x);
                    
                //     renderer.render(loadingScreen.scene, loadingScreen.camera);
                //     return;
                // }

                


              

    
                for(var index=0; index<ships1.length; index+=1){
                    if( ships1[index] === undefined ) continue;
                    if( ships1[index].alive == false ){
                        ships1.splice(index,1);
                        continue;
                    }
                    
                    ships1[index].position.add(ships1[index].velocity);
                    ships1[index].hasMoved += 0.5;

                }  
                for(var index=0; index<ships2.length; index+=1){
                    if( ships2[index] === undefined ) continue;
                    if( ships2[index].alive == false ){                  
                        ships2.splice(index,1);
                        continue;
                    }
                    ships2[index].hasMoved += 0.6;
                    ships2[index].position.add(ships2[index].velocity);
                }  
                for(var index=0; index<ships3.length; index+=1){
                    if( ships3[index] === undefined ) continue;
                    if( ships3[index].alive == false ){
                        ships3.splice(index,1);
                        continue;
                    }
                    ships3[index].hasMoved += 0.7;
                    ships3[index].position.add(ships3[index].velocity);
                }                 
                // go through bullets array and update position
                // remove bullets when appropriate
                for(var index=0; index<bullets.length; index+=1){
                    if( bullets[index] === undefined ) continue;
                    if( bullets[index].alive == false ){
                        bullets.splice(index,1);
                        continue;
                    }
                    
                    bullets[index].position.add(bullets[index].velocity);
                }

                for(var index=0; index<shipBullets.length; index+=1){
                    if( shipBullets[index] === undefined ) continue;
                    if( shipBullets[index].alive == false ){
                        shipBullets.splice(index,1);
                        continue;
                    }
                    
                    shipBullets[index].position.add(shipBullets[index].velocity);
                }

                if(keyboard[87]){ // W key
                    if(camera.position.z <-14){
                    camera.position.x -= Math.sin(camera.rotation.y) * player.speed;
                    camera.position.z -= -Math.cos(camera.rotation.y) * player.speed;
                    }
                }
                if(keyboard[83]){ // S key
                    if(camera.position.z >-18){
                        camera.position.x += Math.sin(camera.rotation.y) * player.speed;
                        camera.position.z += -Math.cos(camera.rotation.y) * player.speed;
                    }
                }
                if(keyboard[65]){ // A key
                    if(camera.position.x < 9.5){
                    camera.position.x += Math.sin(camera.rotation.y + Math.PI/2) * player.speed;
                    camera.position.z += -Math.cos(camera.rotation.y + Math.PI/2) * player.speed;
                    }
                    canon.scale.set(0.5,0.5,0.3);
                }
                if(keyboard[68]){ // D key
                    if(camera.position.x > -9){
                        camera.position.x += Math.sin(camera.rotation.y - Math.PI/2) * player.speed;
                        camera.position.z += -Math.cos(camera.rotation.y - Math.PI/2) * player.speed;
                    }
                    canon.scale.set(-0.5,0.5,0.3);
                }

                
                    canon.position.y = camera.position.y-1;
                    canon.position.x = camera.position.x ;
                    canon.position.z = camera.position.z + 1.5;

                if(player.ship1 <= 0){
                    var spriteMap = new THREE.TextureLoader().load( "https://vignette3.wikia.nocookie.net/clubpenguin/images/2/26/Pirate_Ship.PNG/revision/latest?cb=20141119012531" );
                    var spriteMaterial = new THREE.SpriteMaterial( { map: spriteMap, color: 0xffffff } );
                    var sprite = new THREE.Sprite( spriteMaterial );
                    sprite.position.y = 2;
                    sprite.position.x = 10;
                    sprite.scale.set(5 ,3,1);
                    sprite.castShadow = true;

                    sprite.velocity = new THREE.Vector3(
                        -0.06,
                        0,
                        Math.sin(0)
                    );

                    sprite.hasMoved = 0;
                    sprite.alive = true;
                    setTimeout(function(){
                        sprite.alive = false;
                        scene.remove(sprite);
                    }, 12000);
                    ships1.push(sprite);
                    scene.add( sprite );
                    player.ship1 = 200;

                   
                }               

                if(player.ship2 <= 0){
                    var spriteMap = new THREE.TextureLoader().load( "https://vignette3.wikia.nocookie.net/clubpenguin/images/2/26/Pirate_Ship.PNG/revision/latest?cb=20141119012531" );
                    var spriteMaterial = new THREE.SpriteMaterial( { map: spriteMap, color: 0xffffff } );
                    var sprite = new THREE.Sprite( spriteMaterial );
                    sprite.position.y = 2;
                    sprite.position.x = -10;
                    sprite.position.z = 5;
                    sprite.scale.set(-5 ,3,1);
                    sprite.castShadow = true;
                    sprite.hasMoved = 0;
                    sprite.velocity = new THREE.Vector3(
                        0.08,
                        0,
                        Math.sin(0)
                    );

                    sprite.alive = true;
                    setTimeout(function(){
                        sprite.alive = false;
                        scene.remove(sprite);
                    }, 10000);
                    ships2.push(sprite);
                    scene.add( sprite );
                    player.ship2 = 400;
                }     

                if(player.ship3 <= 0){
                    var spriteMap = new THREE.TextureLoader().load( "https://vignette3.wikia.nocookie.net/clubpenguin/images/2/26/Pirate_Ship.PNG/revision/latest?cb=20141119012531" );
                    var spriteMaterial = new THREE.SpriteMaterial( { map: spriteMap, color: 0xffffff } );
                    var sprite = new THREE.Sprite( spriteMaterial );
                    sprite.position.y = 2;
                    sprite.position.x = 10;
                    sprite.position.z = 10;
                    sprite.scale.set(5 ,3,1);
                    sprite.castShadow = true;
                    sprite.hasMoved = 0;
                    sprite.velocity = new THREE.Vector3(
                        -0.1,
                        0,
                        Math.sin(0)
                    );

                    sprite.alive = true;
                    setTimeout(function(){
                        sprite.alive = false;
                        scene.remove(sprite);
                    }, 9000);
                    ships3.push(sprite);
                    scene.add( sprite );
                    player.ship3 = 700;
                }     

                
                // shoot a bullet
                if(keyboard[32] && player.canShoot <= 0){ // spacebar key
                    // creates a bullet as a Mesh object
                    var spriteMap = new THREE.TextureLoader().load( "http://t4.rbxcdn.com/809acde32f66f425128cd8b76373b023" );
                    var spriteMaterial = new THREE.SpriteMaterial( { map: spriteMap, color: 0xffffff } );
                    var bullet = new THREE.Sprite( spriteMaterial );

                    bullet.scale.set(2,2,2);

		
                    // position the bullet to come from the player's weapon
                    bullet.position.set(
                        camera.position.x,
                        (camera.position.y) - 1,
                        camera.position.z +1.5
                    );
                    
                    // set the velocity of the bullet
                    bullet.velocity = new THREE.Vector3(
                        -Math.sin(camera.rotation.y),
                        0,
                        Math.cos(camera.rotation.y)
                    );
                    
                    // after 1000ms, set alive to false and remove from scene
                    // setting alive to false flags our update code to remove
                    // the bullet from the bullets array
                    bullet.alive = true;
                    setTimeout(function(){
                        bullet.alive = false;
                        scene.remove(bullet);
                    }, 1000);

                    bullet.castShadow = true;
                    
                    // add to scene, array, and set the delay to 10 frames
                    bullets.push(bullet);
                    scene.add(bullet);
                    player.canShoot = 100;

                    
                }
                if(player.canShoot > 0) {
                    player.canShoot -= 1;
                }

                if(player.ship1 > 0) {
                    player.ship1 -= 1;
                }

                if(player.ship2 > 0) {
                    player.ship2 -= 1;
                }
                if(player.ship3 > 0) {
                    player.ship3 -= 1;
                }
                if(health == 2){
                    $('#health3').hide();
                }
                if(health == 1){
                    $('#health2').hide();
                }
                if(health == 0){
                    $('#health1').hide();
                }
                checkCollisionEnemy(ships1);
                checkCollisionEnemy(ships2);
                checkCollisionEnemy(ships3);
                checkCollisionCanon();
                enemyShoot();

                renderer.render(scene, camera);
                requestAnimationFrame(animate);

            }

            function checkCollisionEnemy(ships){
                for(var i=0; i<bullets.length; i+=1){
                    for(var j=0; j<ships.length; j+=1)
                    if ((bullets[i].position.x < ((ships[j].position.x) + 3)) && 
                        (bullets[i].position.x > ((ships[j].position.x) - 2)))
                     if ((bullets[i].position.z < ((ships[j].position.z) + 1)) && 
                        (bullets[i].position.z > ((ships[j].position.z) -1))){
                            scene.remove(ships[j]);
                            ships.splice(j,1);
                            scene.remove(bullets[i]);
                            bullets.splice(i,1);
                            scoreNum += 10;
                            $('#scoreNum').text(scoreNum);
                        }                    
                }
            }
            function checkCollisionCanon(){
                for(var i=0; i<shipBullets.length; i+=1){
                    
                    if ((shipBullets[i].position.x < ((canon.position.x) + 1)) && 
                        (shipBullets[i].position.x > ((canon.position.x) - 1)))
                     if ((shipBullets[i].position.z - 2 < ((canon.position.z) + 1)) && 
                        (shipBullets[i].position.z - 2> ((canon.position.z) -1))){
                            console.log("hit");
                            scene.remove(shipBullets[i]);
                            shipBullets.splice(i,1);
                            health = health -1;
                            var spriteMap = new THREE.TextureLoader().load( "http://4.bp.blogspot.com/-k3-UkbPqmv0/USQDHRwB9JI/AAAAAAAAAGc/PD0kLImZrNc/s1600/ouch_postcard-p239463418636529312baanr_400.jpg" );
                            var spriteMaterial = new THREE.SpriteMaterial( { map: spriteMap, color: 0xffffff } );
                            var ouch = new THREE.Sprite( spriteMaterial );
                            ouch.scale.set(2,2,2);

		
                            // position the bullet to come from the player's weapon
                            ouch.position.set(
                                camera.position.x + 5,
                                (camera.position.y) - 1,
                                camera.position.z + 5
                            );

                            setTimeout(function(){
                                scene.remove(ouch);
                            }, 500);

                            scene.add(ouch);

                        }                    
                }
            }
            function enemyShoot(){
                for (i=0;i<ships1.length;i++){
                    if (ships1[i].hasMoved > 10)
                    {
                        ships1[i].hasMoved = 0;
                        random = Math.floor(Math.random() * 5); 
                        if(random == 0)
                        enemyShooting(ships1[i],1);
                    }             
                }
                for (i=0;i<ships2.length;i++){
                    if (ships2[i].hasMoved > 10)
                    {
                        ships2[i].hasMoved = 0;
                        random = Math.floor(Math.random() * 5); 
                        if(random == 0)
                        enemyShooting(ships2[i],2);
                    }             
                }
                for (i=0;i<ships3.length;i++){
                    if (ships3[i].hasMoved > 10)
                    {
                        ships3[i].hasMoved = 0;
                        random = Math.floor(Math.random() * 5); 
                        if(random == 0)
                        enemyShooting(ships3[i],3);
                    }             
                }
            }

                // shoot a bullet
                function enemyShooting(ship,shipType){ // spacebar key
                    // creates a bullet as a Mesh object
                    var bullet = new THREE.Mesh(
                        new THREE.SphereGeometry(0.5,8,8),
                        new THREE.MeshBasicMaterial({color:0x3a3a3a})
                    );
		
                    // position the bullet to come from the player's weapon
                    bullet.position.set(
                        ship.position.x,
                        (ship.position.y) - 1,
                        ship.position.z
                    );
                    if(shipType == 1){
                        // set the velocity of the bullet
                        bullet.velocity = new THREE.Vector3(
                            -0.05,
                            0,
                            -0.1
                        );
                    }
                    if(shipType == 2){
                        // set the velocity of the bullet
                        bullet.velocity = new THREE.Vector3(
                            0.05,
                            0,
                            -0.3
                        );
                    }
                    if(shipType == 3){
                        // set the velocity of the bullet
                        bullet.velocity = new THREE.Vector3(
                            -0.1,
                            0,
                            -0.5
                        );
                    }
                    
                    bullet.castShadow = true;
                    bullet.receiveShadow = true;

                    // after 1000ms, set alive to false and remove from scene
                    // setting alive to false flags our update code to remove
                    // the bullet from the bullets array
                    bullet.alive = true;
                    setTimeout(function(){
                        bullet.alive = false;
                        scene.remove(bullet);
                    }, 5000);
                    
                    // add to scene, array, and set the delay to 10 frames
                    shipBullets.push(bullet);
                    scene.add(bullet);                    
                }

            function keyDown(event){
                keyboard[event.keyCode] = true;
            }

            function keyUp(event){
                keyboard[event.keyCode] = false;
            }

            window.addEventListener('keydown', keyDown);
            window.addEventListener('keyup', keyUp);

            window.onload = init;

		</script>
	</body>
</html>